commit 79887b2b1a13e0e196c62931adfc26ab7a41a376
Author: Alx-707 <134922845+Alx-707@users.noreply.github.com>
Date:   Wed Feb 4 08:10:56 2026 +0800

    fix: security gates + reduce CI/tooling noise (#18)
    
    * fix(security): move next to deps and make semgrep gate usable
    
    * fix(test): reduce vitest stderr noise
    
    - Silence console output by default in vitest setup (toggle via VITEST_SHOW_LOGS=1)
    
    - Filter jsdom navigation noise from stderr
    
    - Clamp AnimatedCounter delay to avoid TimeoutOverflowWarning
    
    * chore(tools): align knip/madge checks
    
    - Remove knip config hints and ignore Prettier auto-loaded plugins
    
    - Define production scan boundary via tsconfig.knip.json
    
    - Use madge --ts-config to reduce warning noise
    
    - Quiet dotenv load in Playwright config
    
    * refactor(i18n): centralize next-intl pathnames
    
    * test(lib): cover merge-objects prototype pollution keys
    
    * refactor(i18n): derive locale prefix regex from routing locales
    
    * fix(ci): skip vercel deploy when secrets missing
    
    Prevent PR check failures when Vercel credentials are not configured.
    
    * chore(quality-gate): tighten diff coverage exclude globs
    
    * fix(ci): guard vercel deploy with secrets
    
    Use a single-line job if expression to avoid workflow parse failures.
    
    * chore(deps): update baseline-browser-mapping
    
    * refactor(constants): simplify time constants
    
    * fix(ci): skip vercel deploy without secrets
    
    Gate deploy steps behind a secrets preflight.
    
    Prevents PR check failures when Vercel credentials are not configured.
    
    ---------
    
    Co-authored-by: Flood Control Developer <developer@flood-control.com>

diff --git a/.github/workflows/vercel-deploy.yml b/.github/workflows/vercel-deploy.yml
index 3ecf0ae..4b630ca 100644
--- a/.github/workflows/vercel-deploy.yml
+++ b/.github/workflows/vercel-deploy.yml
@@ -24,7 +24,7 @@ jobs:
     runs-on: ubuntu-latest
     timeout-minutes: 15
     # Secrets are not available for fork PRs, and may be unset in template repos.
-    # If secrets are missing, subsequent steps will fail naturally.
+    # When secrets are missing, we skip the actual deploy steps (job still succeeds).
     if: github.event_name != 'workflow_dispatch'
 
     outputs:
@@ -38,6 +38,17 @@ jobs:
 
           submodules: false
 
+      - name: 检查 Vercel 凭据是否配置
+        id: vercel_secrets
+        run: |
+          set -euo pipefail
+          if [ -z "${{ secrets.VERCEL_TOKEN }}" ] || [ -z "${{ secrets.VERCEL_ORG_ID }}" ] || [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
+            echo "configured=false" >> "$GITHUB_OUTPUT"
+            echo "⏭️ Vercel secrets 未配置，跳过部署步骤（不阻断 PR）" >> "$GITHUB_STEP_SUMMARY"
+          else
+            echo "configured=true" >> "$GITHUB_OUTPUT"
+          fi
+
       # 确保先安装 pnpm，再启用 setup-node 的 pnpm 缓存，避免缓存阶段找不到 pnpm
       - name: 设置 pnpm
         uses: pnpm/action-setup@v4
@@ -53,6 +64,7 @@ jobs:
           cache: "pnpm"
 
       - name: 安装 Vercel CLI
+        if: steps.vercel_secrets.outputs.configured == 'true'
         run: |
           set -euo pipefail
           # Pin 到最后一次成功部署版本（避免 vercel@latest 在发布窗口回归）
@@ -62,12 +74,14 @@ jobs:
           CI: true
 
       - name: 拉取 Vercel 环境配置 (preview)
+        if: steps.vercel_secrets.outputs.configured == 'true'
         run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
         env:
           VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
           VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
 
       - name: 诊断 Vercel 关联与版本
+        if: steps.vercel_secrets.outputs.configured == 'true'
         run: |
           set -euo pipefail
           vercel --version
@@ -87,10 +101,12 @@ jobs:
           fi
 
       - name: 安装项目依赖（显式）
+        if: steps.vercel_secrets.outputs.configured == 'true'
         run: pnpm install --frozen-lockfile
 
       - name: 使用 Vercel CLI 构建（保存日志）
         id: vercel_build
+        if: steps.vercel_secrets.outputs.configured == 'true'
         run: |
           set -euo pipefail
           # 将 stdout + stderr 一并保存，供后续质量拦截步骤使用
@@ -102,6 +118,7 @@ jobs:
           CI: true
 
       - name: 阻断：检测 next-intl MISSING_MESSAGE
+        if: steps.vercel_secrets.outputs.configured == 'true'
         run: |
           set -euo pipefail
           if grep -E -i "MISSING_MESSAGE" vercel_build.log; then
@@ -112,7 +129,7 @@ jobs:
           fi
 
       - name: 上传 Vercel 构建日志
-        if: always()
+        if: always() && steps.vercel_secrets.outputs.configured == 'true'
         uses: actions/upload-artifact@v4
         with:
           name: vercel_build.log
@@ -121,6 +138,7 @@ jobs:
 
       - name: 通过 Token 部署预构建产物
         id: vercel_cli_deploy
+        if: steps.vercel_secrets.outputs.configured == 'true'
         run: |
           set -euo pipefail
           # GitHub Actions 环境偶发 IPv6 连接问题时，优先使用 IPv4
