name: Cloudflare Workers 部署

# ============================================================================
# 职责：Cloudflare Workers 部署 + MISSING_MESSAGE 检测 + 健康检查
# 触发：手动触发（workflow_dispatch）
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

concurrency:
  group: ${{ github.workflow }}-${{ inputs.environment }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: 构建并部署到 Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: 检查 Cloudflare 凭据
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "❌ Cloudflare secrets 未配置"
            echo "需要: CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID"
            exit 1
          fi
          echo "✅ Cloudflare 凭据已配置"

      - name: 设置 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1
          run_install: false
          standalone: true

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 构建（Cloudflare Workers）
        id: build
        run: |
          set -euo pipefail
          pnpm build:cf 2>&1 | tee cf_build.log
          echo "log-path=$(pwd)/cf_build.log" >> "$GITHUB_OUTPUT"
        env:
          CI: true

      - name: 阻断：检测 next-intl MISSING_MESSAGE
        run: |
          set -euo pipefail
          if grep -E -i "MISSING_MESSAGE" cf_build.log; then
            echo "❌ Detected next-intl MISSING_MESSAGE in build logs"
            exit 1
          else
            echo "✅ No MISSING_MESSAGE found"
          fi

      - name: 上传构建日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cf-build-log-${{ inputs.environment }}
          path: cf_build.log
          if-no-files-found: ignore

      - name: 部署到 Cloudflare Workers
        id: deploy
        run: |
          set -euo pipefail
          DEPLOY_OUTPUT=$(pnpm exec opennextjs-cloudflare deploy --env ${{ inputs.environment }} 2>&1) || {
            echo "❌ 部署失败"
            echo "$DEPLOY_OUTPUT"
            exit 1
          }
          echo "$DEPLOY_OUTPUT"
          # 提取部署 URL — 优先从输出中正则匹配，否则按环境使用固定 URL
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+\.workers\.dev' | head -1 || echo "")
          if [ -z "$DEPLOY_URL" ]; then
            if [ "${{ inputs.environment }}" = "production" ]; then
              DEPLOY_URL="https://tianze-pipe.com"
            else
              DEPLOY_URL="https://preview.tianze-pipe.com"
            fi
            echo "⚠️ 未从部署输出中提取到 URL，使用环境固定 URL: $DEPLOY_URL"
          fi
          echo "deployment-url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"
          echo "✅ 部署成功"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: 部署总结
        run: |
          echo "## ☁️ Cloudflare Workers 部署总结" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **环境**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **分支**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **提交**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **触发者**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.deploy.outputs.deployment-url }}" ]; then
            echo "- **部署 URL**: ${{ steps.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          fi

  post-deploy-verification:
    name: 部署后验证
    runs-on: ubuntu-latest
    needs: build-and-deploy
    timeout-minutes: 10
    if: needs.build-and-deploy.outputs.deployment_url != ''

    steps:
      - name: 等待部署就绪
        run: |
          set -euo pipefail
          url="${{ needs.build-and-deploy.outputs.deployment_url }}"
          echo "等待部署就绪: $url"

          max_tries=30
          delay=5

          for i in $(seq 1 $max_tries); do
            status=$(curl -s -o /dev/null -w "%{http_code}" -I "$url" || echo "000")
            if [ "$status" = "000" ]; then
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
            fi

            echo "第 $i 次探测: $status"
            if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
              echo "部署已就绪"
              exit 0
            fi

            if [ $((i % 10)) -eq 0 ] && [ "$delay" -lt 15 ]; then
              delay=$((delay + 5))
            fi
            sleep "$delay"
          done
          echo "等待超时" >&2
          exit 1

      - name: 健康检查
        run: |
          set -euo pipefail
          BASE="${{ needs.build-and-deploy.outputs.deployment_url }}"

          check_url() {
            local url="$1"
            local desc="$2"
            local max_retries=3
            local attempt=1

            echo "检查 $desc..."
            while [ $attempt -le $max_retries ]; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$url") || HTTP_CODE="000"
              if [ "$HTTP_CODE" = "200" ]; then
                echo "  ✓ $desc (HTTP $HTTP_CODE)"
                return 0
              fi
              echo "  尝试 $attempt/$max_retries: HTTP $HTTP_CODE"
              sleep $((attempt * 3))
              attempt=$((attempt + 1))
            done
            echo "  ❌ $desc 失败"
            return 1
          }

          check_url "$BASE" "根路径"
          check_url "$BASE/en" "英文首页"
          check_url "$BASE/zh" "中文首页"
          check_url "$BASE/api/health" "Health API"
          echo "✅ 健康检查通过"
