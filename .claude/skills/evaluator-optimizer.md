---
name: evaluator-optimizer
description: 生成-评估-迭代循环，自动修复直到通过
triggers:
  - 生成
  - 创建
  - 实现
---

# Evaluator-Optimizer 工作流

> 双 Agent 模式：Generator 生成 + Evaluator 独立评估 + 自动迭代修复

## 适用场景

- ✅ 功能实现（有测试用例）
- ✅ i18n 内容生成（有术语表）
- ✅ 性能优化（有 Lighthouse 指标）
- ✅ 代码重构（有类型检查 + 测试）

## 不适用场景

- ❌ 探索性任务（无明确评估标准）
- ❌ 纯设计讨论（无可验证输出）

## 工作流

```
生成初始版本
      ↓
   评估 ──→ 通过？──→ 完成
      ↑        ↓ 否
      └── 修复 ←┘

（最多 3 次迭代）
```

## Step 1: 生成

根据需求生成初始代码/内容。

## Step 2: 评估

### 代码生成评估维度

| 维度 | 检查方式 | 通过标准 |
|------|---------|---------|
| 正确性 | `pnpm test --related` | 全部通过 |
| 类型安全 | `pnpm type-check` | 无错误 |
| 复杂度 | 人工检查 | 函数 ≤120 行 |
| 规范 | `pnpm lint:check` | 无错误 |
| i18n | grep 硬编码文本 | 无硬编码 |

### i18n 内容评估维度

| 维度 | 检查方式 | 通过标准 |
|------|---------|---------|
| 术语一致 | 对照 `docs/tianze-企业信息/` | 术语匹配 |
| 中英对应 | 语义对比 | 意思一致 |
| key 命名 | 对照 `.claude/rules/i18n.md` | 符合规范 |

### 性能优化评估维度

```bash
pnpm perf:lighthouse
```

| 指标 | 通过标准 |
|------|---------|
| Performance | ≥ 0.85 |
| LCP | ≤ 4500ms |
| CLS | ≤ 0.15 |

## Step 3: 迭代

评估失败时：

1. **记录失败原因**
   ```
   [失败] 类型检查：Property 'foo' does not exist on type 'Bar'
   ```

2. **针对性修复**
   - 仅修复评估指出的问题
   - 不引入无关改动

3. **重新评估**
   - 运行相同的评估命令
   - 确认问题已修复

4. **计数检查**
   - 迭代次数 +1
   - 超过 3 次 → 停止

## Step 4: 终止

### 成功终止

```
✅ 评估通过
- 测试：15 passed
- 类型：无错误
- 规范：无警告
```

### 失败终止

```
❌ 3 次迭代仍失败

失败原因：
- [迭代 1] 类型错误：缺少必需属性
- [迭代 2] 测试失败：边界情况未处理
- [迭代 3] 测试失败：异步逻辑错误

需要人工介入：
1. 检查需求是否清晰
2. 检查测试用例是否合理
3. 考虑是否需要重新设计
```

## 使用示例

### 功能实现

```
用户：实现产品搜索 API

Agent：
1. [生成] POST /api/products/search 初始实现
2. [评估] pnpm test... 失败：缺少分页处理
3. [修复] 添加 page/pageSize 参数
4. [评估] pnpm test... 失败：空查询未处理
5. [修复] 添加空查询默认返回热门产品
6. [评估] pnpm test... 通过 ✅
7. [评估] pnpm type-check... 通过 ✅
8. 完成（2 次迭代）
```

### i18n 生成

```
用户：生成产品页中英文文案

Agent：
1. [生成] 初始文案
2. [评估] 术语检查... 失败："conduit" 应统一为 "electrical conduit"
3. [修复] 统一术语
4. [评估] 术语检查... 通过 ✅
5. [评估] key 命名检查... 通过 ✅
6. 完成（1 次迭代）
```

### 性能优化

```
用户：优化首页 LCP

Agent：
1. [生成] 添加图片懒加载 + 预加载关键资源
2. [评估] Lighthouse... 失败：LCP 5200ms > 4500ms
3. [修复] 添加 priority 属性到 hero 图片
4. [评估] Lighthouse... 通过：LCP 3800ms ✅
5. 完成（1 次迭代）
```
